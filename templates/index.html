<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartAI Crop Disease Tracker</title>
    <link rel="stylesheet" href="static/styles.css">

    <!-- Google Translate Script -->
    <script type="text/javascript">
        function googleTranslateElementInit() {
            new google.translate.TranslateElement({
                pageLanguage: 'en',  // Default language
                includedLanguages: 'af,sq,am,ar,hy,az,eu,be,bn,bg,my,ca,zh-CN,zh-TW,hr,cs,da,nl,en,et,fi,fr,gl,ka,de,el,gu,iw,hi,hu,is,id,ga,it,ja,jv,kn,kk,km,ko,ku,ky,lo,lv,lt,lb,mk,mg,ms,ml,mt,mi,mr,mn,ne,no,fa,pl,pt,pa,ro,ru,sm,gd,sr,st,si,sk,sl,es,su,sw,sv,tg,ta,tt,te,th,tr,uk,ur,uz,vi,cy,xh,yi,zu', // All supported languages
                layout: google.translate.TranslateElement.InlineLayout.SIMPLE
            }, 'google_translate_element');
        }
    </script>
    <script type="text/javascript" src="//translate.google.com/translate_a/element.js?cb=googleTranslateElementInit"></script>

    <!-- Speech Recognition API -->
    <script>
        let recognition;
        let isListening = false;

        function startRecognition() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Your browser does not support speech recognition. Please use Google Chrome.");
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'en-US'; // Set language for recognition

            recognition.onstart = function () {
                isListening = true;
                console.log('Speech recognition started');
            };

            recognition.onresult = function (event) {
                const transcript = event.results[0][0].transcript;
                document.querySelector('.search-bar input').value = transcript; // Populate input field
                stopRecognition(); // Stop recognition after getting result
            };

            recognition.onend = function () {
                isListening = false;
                console.log('Speech recognition ended');
            };

            recognition.onerror = function (event) {
                console.error('Speech recognition error:', event.error);
                stopRecognition();
            };

            recognition.start();
        }

        function stopRecognition() {
            if (isListening) {
                recognition.stop();
            }
        }
    </script>
</head>

<body>
    <!-- Google Translate Element -->
    <div id="google_translate_element"></div>

    <div class="container">
        <nav>
            <ul>
                <li><a href="index.html">Home</a></li>
                <li><a href="contact.html">Contact Us</a></li>
                <li id="user-greeting"></li>
                <li><a href="/auth/google">Sign In with Google</a></li>
            </ul>

            <div class="search-bar">
                <input type="text" placeholder="Search Products...">
                <button type="button" onclick="startRecognition()">ðŸŽ¤</button> <!-- Speech to Text Button -->
                <button type="submit">&#128269;</button>
            </div>
        </nav>

        <div class="content-wrapper">
            <div class="left-section">
                <h2>Empowering Farmers with Smart AI Crop Disease Tracker</h2>
                <h1>Protect Your Crops with AI Disease Prediction</h1>
                <p id="text-to-read">Upload a photo of your crop to get an instant disease diagnosis using our advanced AI technology. Get actionable insights to ensure the best yield and healthier crops.</p>
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="file" id="fileInput" accept="image/*" required>
                    <button type="submit">Submit</button>
                </form>
                <h3 id="predictionResult"></h3>
            </div>

            <div class="right-section">
                <div class="leaf-icons"></div>
                <div class="dots">
                    <span class="dot"></span>
                    <span class="dot"></span>
                    <span class="dot"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Text-to-Speech Script -->
    <script type="text/javascript">
        function speakText(text, lang = 'en') {
            const synth = window.speechSynthesis;
            const utterThis = new SpeechSynthesisUtterance(text);
            utterThis.lang = lang;

            // Error handling
            utterThis.onerror = function (event) {
                console.error('Speech synthesis error:', event.error);
            };

            console.log(`Speaking text: "${text}" in language: ${lang}`);  // Debugging log
            synth.speak(utterThis);
        }

        // Language code mapping for supported text-to-speech languages
        const langMap = {
            'en': 'en-US', 'fr': 'fr-FR', 'es': 'es-ES', 'de': 'de-DE', 'hi': 'hi-IN', 'ar': 'ar-SA',
            'it': 'it-IT', 'ja': 'ja-JP', 'ko': 'ko-KR', 'ru': 'ru-RU', 'zh-CN': 'zh-CN', 'pt': 'pt-PT',
            'nl': 'nl-NL', 'pl': 'pl-PL', 'sv': 'sv-SE', 'tr': 'tr-TR', 'uk': 'uk-UA',
            'bn': 'bn-BD', 'ta': 'ta-IN', 'te': 'te-IN', 'si': 'si-LK', 'hy': 'hy-AM',
            'ml': 'ml-IN', 'km': 'km-KH', 'vi': 'vi-VN', 'my': 'my-MM', // Add more languages as needed
        };

        // Automatically trigger text-to-speech after translation
        function autoSpeakText() {
            const selectedText = document.getElementById('text-to-read').innerText;
            const langCode = document.querySelector('.goog-te-combo').value;
            const speechLang = langMap[langCode] || 'en-US'; // Fallback to English if not found
            speakText(selectedText, speechLang);
        }

        // Log available voices
        window.speechSynthesis.onvoiceschanged = function () {
            const voices = window.speechSynthesis.getVoices();
            voices.forEach(function (voice) {
                console.log(`${voice.name} (${voice.lang})`);
            });
        };

        // Add event listener to trigger speech after language change
        window.onload = function () {
            const googleTranslateDropDown = document.querySelector('.goog-te-combo');
            if (googleTranslateDropDown) {
                googleTranslateDropDown.addEventListener('change', autoSpeakText);
            }

            // Event listener for text selection
            document.addEventListener('mouseup', function () {
                const selectedText = window.getSelection().toString();  // Get the selected text
                console.log(`Selected text: "${selectedText}"`);  // Debugging log
                if (selectedText) {
                    const langCode = googleTranslateDropDown ? googleTranslateDropDown.value : 'en';  // Get the selected language code
                    const speechLang = langMap[langCode] || 'en-US';  // Map the language code to a TTS voice, default to 'en-US'

                    // Check if the selected text's language is supported
                    const detectedLang = detectLanguage(selectedText);
                    const finalLang = langMap[detectedLang] || speechLang; // Use detected language if available

                    console.log(`Language code for TTS: ${finalLang}`);  // Debugging log
                    speakText(selectedText, finalLang);  // Speak the selected text
                }
            });
        };

        // Function to detect the language of the selected text
        function detectLanguage(text) {
            if (/[\u0900-\u097F]/.test(text)) {
                return 'hi'; // Hindi
            } else if (/[\u0980-\u09FF]/.test(text)) {
                return 'bn'; // Bengali
            } else if (/[\u4E00-\u9FFF]/.test(text)) {
                return 'zh'; // Chinese
            } else if (/[\u0600-\u06FF]/.test(text)) {
                return 'ar'; // Arabic
            } else if (/[\uAC00-\uD7AF]/.test(text)) {
                return 'ko'; // Korean
            } else if (/[\u3040-\u309F\u30A0-\u30FF]/.test(text)) {
                return 'ja'; // Japanese
            } else if (/[\u0B80-\u0BFF]/.test(text)) {
                return 'ta'; // Tamil
            } else if (/[\u0C00-\u0C7F]/.test(text)) {
                return 'te'; // Telugu
            }
            return 'en'; // Default to English if no language matches
        }
    </script>

    <!-- Image Upload Handling -->
    <script>
        document.getElementById('uploadForm').addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission

            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0]; // Get the selected file
            const formData = new FormData(); // Create FormData object
            formData.append('image', file); // Append file to FormData

            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json(); // Parse JSON response
                const predictionResult = document.getElementById('predictionResult');
                predictionResult.textContent = `Prediction: ${data.prediction}`; // Display prediction result

            } catch (error) {
                console.error('Error:', error); // Handle error
                alert('An error occurred while processing the image. Please try again.');
            }
        });
    </script>
</body>

</html>
